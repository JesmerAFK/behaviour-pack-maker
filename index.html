
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bedrock Pack Studio</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- JSZip for packing/unpacking files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['Roboto Mono', 'monospace'],
                    },
                    colors: {
                        'primary': '#10b981', // emerald-500
                        'primary-hover': '#059669', // emerald-600
                        'background': '#111827', // gray-900
                        'surface': '#1f2937', // gray-800
                        'muted': '#4b5563', // gray-600
                        'subtle': '#374151', // gray-700
                    }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0",
    "jszip": "https://aistudiocdn.com/jszip@^3.10.1"
  }
}
</script>
</head>
<body class="bg-background text-gray-200 font-sans h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-surface p-4 shadow-lg flex justify-between items-center z-10 shrink-0">
        <div class="flex items-center space-x-3">
            <svg class="w-8 h-8 text-primary" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 16.5C21 16.5 20 17.5 16 17.5C13 17.5 12 16.5 12 16.5C12 16.5 12 15.5 15 15.5C18 15.5 21 16.5 21 16.5Z" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/><path d="M12 12.5C12 12.5 11 13.5 7 13.5C4 13.5 3 12.5 3 12.5C3 12.5 3 11.5 6 11.5C9 11.5 12 12.5 12 12.5Z" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/><path d="M16.5 21C16.5 21 17.5 20 17.5 16C17.5 13 16.5 12 16.5 12C16.5 12 15.5 12 15.5 15C15.5 18 16.5 21 16.5 21Z" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/><path d="M12.5 12C12.5 12 13.5 11 13.5 7C13.5 4 12.5 3 12.5 3C12.5 3 11.5 3 11.5 6C11.5 9 12.5 12 12.5 12Z" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/><path d="M7.5 21C7.5 21 8.5 20 8.5 16C8.5 13 7.5 12 7.5 12C7.5 12 6.5 12 6.5 15C6.5 18 7.5 21 7.5 21Z" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/><path d="M3 16.5C3 16.5 4 17.5 8 17.5C11 17.5 12 16.5 12 16.5C12 16.5 12 15.5 9 15.5C6 15.5 3 16.5 3 16.5Z" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/></svg>
            <h1 class="text-2xl font-bold text-white">Bedrock Pack Studio</h1>
        </div>
        <div class="flex items-center space-x-2">
            <input type="file" id="import-input" class="hidden" accept=".zip,.mcpack" />
            <button id="import-btn" class="bg-surface border border-muted text-gray-300 hover:bg-subtle hover:text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                </svg>
                <span>Import</span>
            </button>
            <button id="download-btn" class="bg-primary text-white font-bold py-2 px-6 rounded-lg hover:bg-primary-hover transition-colors flex items-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed">
                <span id="download-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                </span>
                <span id="spinner-icon" class="hidden">
                     <svg class="animate-spin -ml-1 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </span>
                <span id="download-text">Download</span>
            </button>
        </div>
    </header>

    <main class="flex-grow flex flex-col md:flex-row h-full overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-full md:w-72 lg:w-80 bg-surface border-r border-subtle flex flex-col overflow-hidden shrink-0">
            <!-- File Tree -->
            <div class="flex-1 flex flex-col overflow-hidden min-h-[40%] border-b border-subtle">
                 <div class="px-3 py-2 font-bold text-xs text-muted uppercase tracking-wider flex justify-between items-center bg-surface shrink-0">
                    <span>Explorer</span>
                    <button id="refresh-files" class="text-[10px] hover:text-white" title="Refresh File List">Refresh</button>
                </div>
                <div id="file-tree" class="flex-1 overflow-y-auto p-2"></div>
            </div>
            
            <!-- Configurator (Scrollable) -->
             <div class="flex-1 overflow-y-auto p-4 bg-[#1a2330]">
                <h2 class="text-xl font-bold text-white mb-4 sticky top-0 bg-[#1a2330] py-2 z-10">Pack Configuration</h2>
                <div class="space-y-4 pb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Pack Name</label>
                        <input id="conf-name" class="w-full p-2 bg-subtle border border-muted rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-gray-200">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Description</label>
                        <textarea id="conf-desc" rows="3" class="w-full p-2 bg-subtle border border-muted rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-gray-200 resize-y"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Author</label>
                        <input id="conf-author" class="w-full p-2 bg-subtle border border-muted rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-gray-200">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">Version</label>
                            <input id="conf-version" class="w-full p-2 bg-subtle border border-muted rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-gray-200" placeholder="1.0.0">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">Min Engine</label>
                            <input id="conf-engine" class="w-full p-2 bg-subtle border border-muted rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-gray-200" placeholder="1.21.0">
                        </div>
                    </div>
                    
                    <div class="pt-2">
                         <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-bold text-gray-300">Dependencies</label>
                         </div>
                         <div id="dependencies-list" class="space-y-2"></div>
                         <button id="add-dep-btn" class="w-full mt-2 bg-subtle text-gray-300 text-sm py-1 px-2 rounded hover:bg-muted transition-colors">+ Add Dependency</button>
                    </div>

                    <div class="pt-4 border-t border-subtle">
                        <button id="save-config-btn" class="w-full bg-primary text-white font-bold py-2 px-4 rounded-lg hover:bg-primary-hover transition-colors">Save Configuration</button>
                         <p class="text-xs text-muted mt-2 text-center">Updates manifest.json</p>
                    </div>
                    
                    <div class="pt-4 border-t border-subtle">
                         <button id="reset-api-key" class="w-full bg-red-900/30 border border-red-900 text-red-200 text-xs py-1 px-2 rounded hover:bg-red-900/50 transition-colors">Reset API Key</button>
                    </div>
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <div class="flex-1 flex flex-col bg-background overflow-hidden">
             <!-- Tabs -->
             <nav class="flex space-x-1 border-b border-subtle bg-surface px-4 shrink-0">
                 <button id="tab-files" class="py-3 px-4 font-semibold transition-colors text-primary border-b-2 border-primary">Files</button>
                 <button id="tab-texture" class="py-3 px-4 font-semibold transition-colors text-gray-400 hover:text-white border-b-2 border-transparent">Pack Icon</button>
             </nav>

             <!-- Files View -->
             <div id="view-editor" class="flex-1 flex flex-col p-4 gap-4 overflow-hidden">
                 
                 <!-- Code Area -->
                 <div class="flex-1 flex flex-col relative rounded-lg border border-subtle bg-surface overflow-hidden h-full">
                    <div class="bg-surface border-b border-subtle px-4 py-2 text-xs text-muted font-mono flex justify-between shrink-0">
                        <span id="editor-filename">No file selected</span>
                        <span id="editor-stats">0 chars</span>
                    </div>
                    
                    <div class="flex-1 flex relative min-h-0 bg-[#1e1e1e] overflow-hidden">
                        <!-- Textarea -->
                        <textarea id="code-input" class="flex-1 p-4 bg-[#1e1e1e] font-mono text-gray-300 resize-none focus:outline-none text-sm leading-relaxed whitespace-pre overflow-auto" spellcheck="false" wrap="off"></textarea>
                        <!-- Image Preview Placeholder -->
                        <div id="image-preview-area" class="hidden w-full h-full flex items-center justify-center bg-[#1e1e1e] text-muted">
                            <img id="image-preview-img" class="max-w-full max-h-full object-contain" />
                        </div>
                    </div>
                 </div>

                 <!-- AI Panel -->
                 <div class="flex flex-col gap-2 shrink-0 h-auto">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-2 text-sm text-primary">
                           <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M15.405 2.138a.75.75 0 01.638.92l-2.033 6.1a.75.75 0 01-1.33.001l-.85-2.55a.75.75 0 00-.4-1.033L5.28 2.97a.75.75 0 01.597-1.373l8.5 1.7a.75.75 0 011.028.841zM3.75 9.19L6.5 6.94l-2.75-2.25v4.5zM12.5 15.25a.75.75 0 01.75-.75h.008a.75.75 0 01.75.75v.008a.75.75 0 01-.75.75h-.008a.75.75 0 01-.75-.75v-.008zM15.25 12.5a.75.75 0 00-.75.75v.008c0 .414.336.75.75.75h.008a.75.75 0 00.75-.75v-.008a.75.75 0 00-.75-.75h-.008zM12.5 11.25a.75.75 0 01.75-.75h.008a.75.75 0 01.75.75v.008a.75.75 0 01-.75.75h-.008a.75.75 0 01-.75-.75v-.008zM9.75 15.25a.75.75 0 00-.75.75v.008c0 .414.336.75.75.75h.008a.75.75 0 00.75-.75v-.008a.75.75 0 00-.75-.75h-.008z" clip-rule="evenodd" /></svg>
                           <p class="font-semibold">AI Assistant</p>
                        </div>
                        <button id="debug-btn" class="hidden bg-primary/20 text-primary hover:bg-primary/30 text-xs py-1 px-2 rounded transition-colors">Debug Current File</button>
                    </div>
                    
                    <div class="relative">
                      <textarea
                        id="ai-prompt"
                        placeholder="Ask to create files (e.g. 'Make a new items/sword.json') or modify code..."
                        class="w-full p-3 pr-12 bg-surface border border-subtle rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-primary transition-colors text-gray-300"
                        rows="2"
                      ></textarea>
                      <button
                        id="send-ai-btn"
                        class="absolute right-3 top-1/2 -translate-y-1/2 p-2 rounded-full bg-primary text-white hover:bg-primary-hover disabled:bg-muted disabled:cursor-not-allowed transition-colors"
                      >
                         <svg id="send-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                        </svg>
                        <svg id="ai-spinner" class="hidden animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                      </button>
                    </div>
                    <div id="ai-status" class="hidden max-h-32 overflow-y-auto bg-surface border border-subtle rounded p-2 text-xs font-mono text-gray-300"></div>
                 </div>
             </div>

             <!-- Texture View -->
             <div id="view-texture" class="hidden flex-1 p-6 gap-6 overflow-y-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-6xl mx-auto w-full">
                    <div class="bg-surface border border-subtle rounded-lg shadow-md p-4">
                        <h2 class="text-xl font-bold mb-4">Pack Icon Generator</h2>
                        <p class="text-sm text-muted mb-4">
                          Generate a unique 512x512px icon for your pack. It will be saved as `pack_icon.png`.
                          Powered by Pollinations.ai.
                        </p>
                        <div class="space-y-2">
                          <label class="block text-sm font-medium text-gray-300 mb-1">Icon Prompt</label>
                          <input id="texture-prompt" class="w-full p-2 bg-subtle border border-muted rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-gray-200" placeholder="e.g., A glowing emerald sword on a shield">
                        </div>
                        <button id="gen-texture-btn" class="mt-4 w-full bg-primary text-white font-bold py-2 px-4 rounded-lg hover:bg-primary-hover transition-colors disabled:bg-muted">
                          Generate Icon
                        </button>
                         <p id="texture-error" class="text-red-400 mt-2 text-sm hidden"></p>
                    </div>
                    
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold">Current Pack Icon</h3>
                        <div class="bg-surface border border-subtle rounded-lg shadow-md aspect-square flex items-center justify-center overflow-hidden relative group">
                            <div id="no-icon-msg" class="text-muted p-4 text-center">No icon generated yet.</div>
                            <img id="current-pack-icon" class="hidden w-full h-full object-cover" />
                            <div id="icon-overlay" class="hidden absolute bottom-0 left-0 right-0 bg-black bg-opacity-70 p-2 text-center text-xs text-white opacity-0 group-hover:opacity-100 transition-opacity">pack_icon.png</div>
                        </div>
                    </div>
                </div>
             </div>
        </div>
    </main>

    <script type="module">
        import { GoogleGenAI } from "https://esm.run/@google/genai";

        // ==========================================
        // State Management
        // ==========================================
        const state = {
            files: [], // { path: string, content: string, isBinary: boolean }
            config: {
                name: 'My Awesome Pack',
                description: 'A new pack created with Bedrock Pack Studio.',
                author: 'Player',
                version: [1, 0, 0],
                minEngineVersion: [1, 21, 0],
                dependencies: [
                    { module_name: '@minecraft/server', version: '2.4.0-beta' },
                    { module_name: '@minecraft/server-ui', version: '2.1.0-beta' },
                ]
            },
            selectedFile: null,
            packIconBase64: null,
            isGenerating: false
        };

        const DEFAULT_SCRIPT = `// Generated with Bedrock Pack Studio
import { world } from '@minecraft/server';

world.beforeEvents.chatSend.subscribe((eventData) => {
  const player = eventData.sender;
  if (eventData.message.toLowerCase() === 'hello') {
    player.sendMessage('Hello from your new pack!');
    eventData.cancel = true;
  }
});
`;

        // ==========================================
        // API Key & Service
        // ==========================================
        function getApiKey() {
            let key = localStorage.getItem("GEMINI_API_KEY");
            if (!key) {
                key = prompt("Please enter your Google Gemini API Key:");
                if (key) {
                    localStorage.setItem("GEMINI_API_KEY", key);
                }
            }
            return key;
        }

        // Initialize State
        function init() {
            // Create default files
            const manifest = generateManifest(state.config);
            state.files = [
                { path: 'manifest.json', content: JSON.stringify(manifest, null, 2), isBinary: false },
                { path: 'scripts/main.js', content: DEFAULT_SCRIPT, isBinary: false }
            ];
            state.selectedFile = 'scripts/main.js';

            // Setup UI
            renderFileTree();
            renderConfig();
            renderEditor();
            setupEventListeners();

            // Initial Tab
            switchTab('Files');
        }

        function getAIClient() {
            const key = getApiKey();
            if (!key) {
                alert("API Key is required for AI features.");
                return null;
            }
            return new GoogleGenAI({ apiKey: key });
        }

        // ==========================================
        // Logic: AI Generation
        // ==========================================
        const SCRIPT_SYSTEM_PROMPT = `You are an expert Minecraft Bedrock addon developer.
Your task is to generate or modify files for a Bedrock Behavior Pack.

You MUST return a strictly valid JSON object with the following structure:
{
  "files": [
    {
      "path": "scripts/main.js",
      "content": "... javascript code ..."
    },
    {
      "path": "entities/my_entity.json",
      "content": "... json content ..."
    }
  ],
  "explanation": "Brief description of changes"
}

Constraints:
- 'path' must be the relative path.
- 'content' must be the raw text content.
- Use '@minecraft/server' version '2.4.0-beta' and '@minecraft/server-ui' version '2.1.0-beta'.
- Do NOT use markdown formatting (no \`\`\`json).
- Return ONLY the JSON object.
- If the user asks to modify code, return the FULL content of the modified file(s).`;

        async function generateFiles(promptText) {
            const ai = getAIClient();
            if (!ai) return;

            const fileContext = state.files
                .filter(f => !f.isBinary && f.content.length < 5000) // Limit context size
                .map(f => `File: ${f.path}\n---\n${f.content}\n---\n`)
                .join("\n");

            const fullPrompt = `User Request: "${promptText}"

Current Project Files:
${fileContext}

Generate the necessary file updates/creations in JSON format.`;

            try {
                const response = await ai.models.generateContent({
                    model: 'gemini-2.5-flash',
                    contents: fullPrompt,
                    config: {
                        systemInstruction: SCRIPT_SYSTEM_PROMPT,
                        responseMimeType: "application/json"
                    }
                });

                const result = JSON.parse(response.text);
                
                if (result.files) {
                    result.files.forEach(f => {
                        updateFileInState(f.path, f.content);
                    });
                    // If new files created, select the first one
                    if (result.files.length > 0) {
                        state.selectedFile = result.files[0].path;
                        renderFileTree();
                        renderEditor();
                    }
                }
                return result.explanation;
            } catch (e) {
                console.error(e);
                throw new Error("AI Generation Failed: " + e.message);
            }
        }

        async function checkScript(content) {
            const ai = getAIClient();
            if (!ai) return "API Key missing.";
            
            try {
                const response = await ai.models.generateContent({
                    model: 'gemini-2.5-flash',
                    contents: `Check this Minecraft script for errors:\n\n${content}`,
                    config: {
                         systemInstruction: "You are a Minecraft Bedrock script debugger. Identify errors. If valid, say 'No issues found'.",
                    }
                });
                return response.text;
            } catch (e) {
                return "Error checking script: " + e.message;
            }
        }

        // ==========================================
        // Logic: Pollinations.ai Image Gen
        // ==========================================
        async function generatePollinationsImage(promptText) {
            const fullPrompt = `${promptText}, pixel art, minecraft style`;
            // Pollinations URL structure
            const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(fullPrompt)}?width=512&height=512&nologo=true`;
            
            const response = await fetch(url);
            if (!response.ok) throw new Error("Failed to fetch image from Pollinations.");
            
            const blob = await response.blob();
            
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    // Result is "data:image/jpeg;base64,..."
                    // Split to get just base64
                    resolve(reader.result.split(',')[1]); 
                };
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        // ==========================================
        // Logic: Pack Management
        // ==========================================
        function generateManifest(config) {
            return {
                format_version: 2,
                header: {
                    name: `${config.name} [BP]`,
                    description: config.description,
                    uuid: crypto.randomUUID(),
                    version: config.version,
                    min_engine_version: config.minEngineVersion,
                },
                modules: [
                    { type: 'data', uuid: crypto.randomUUID(), version: config.version },
                    { type: 'script', uuid: crypto.randomUUID(), version: config.version, entry: 'scripts/main.js' },
                ],
                dependencies: config.dependencies,
                metadata: { authors: [config.author] },
            };
        }

        function updateFileInState(path, content, isBinary = false) {
            const idx = state.files.findIndex(f => f.path === path);
            if (idx !== -1) {
                state.files[idx] = { path, content, isBinary };
            } else {
                state.files.push({ path, content, isBinary });
            }
            if (path === 'pack_icon.png') {
                state.packIconBase64 = content;
                renderTexturePreview();
            }
        }

        async function downloadPack() {
            const zip = new JSZip();
            
            // Ensure manifest is up to date
            const manifest = generateManifest(state.config);
            // Update manifest in files state first
            updateFileInState('manifest.json', JSON.stringify(manifest, null, 2));

            state.files.forEach(f => {
                if (f.isBinary) {
                    zip.file(f.path, f.content, { base64: true });
                } else {
                    zip.file(f.path, f.content);
                }
            });

            const content = await zip.generateAsync({ type: 'blob' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = `${state.config.name.replace(/[^a-z0-9]/gi, '_')}.mcpack`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function importPack(file) {
            const zip = await JSZip.loadAsync(file);
            state.files = [];
            
            const promises = [];
            
            zip.forEach((relativePath, zipEntry) => {
                if (zipEntry.dir) return;
                const promise = (async () => {
                    const ext = relativePath.split('.').pop().toLowerCase();
                    const isBinary = ['png','jpg','jpeg','tga','fsb','bin'].includes(ext);
                    
                    if (isBinary) {
                        const content = await zipEntry.async('base64');
                        state.files.push({ path: relativePath, content, isBinary: true });
                        if (relativePath === 'pack_icon.png') state.packIconBase64 = content;
                    } else {
                        const content = await zipEntry.async('string');
                        state.files.push({ path: relativePath, content, isBinary: false });
                        
                        if (relativePath === 'manifest.json') {
                            try {
                                const m = JSON.parse(content);
                                state.config.name = m.header.name.replace(' [BP]', '');
                                state.config.description = m.header.description;
                                state.config.version = m.header.version;
                                state.config.minEngineVersion = m.header.min_engine_version;
                                state.config.author = m.metadata?.authors?.[0] || 'Unknown';
                                state.config.dependencies = m.dependencies || [];
                            } catch (e) { console.error("Manifest parse error", e); }
                        }
                    }
                })();
                promises.push(promise);
            });
            
            await Promise.all(promises);
            state.selectedFile = state.files.find(f => f.path.endsWith('.js'))?.path || state.files[0]?.path;
            
            renderFileTree();
            renderConfig();
            renderEditor();
            renderTexturePreview();
        }

        // ==========================================
        // UI Rendering
        // ==========================================
        const els = {
            fileTree: document.getElementById('file-tree'),
            editor: document.getElementById('code-input'),
            editorFileName: document.getElementById('editor-filename'),
            editorStats: document.getElementById('editor-stats'),
            imagePreviewArea: document.getElementById('image-preview-area'),
            imagePreviewImg: document.getElementById('image-preview-img'),
            
            confName: document.getElementById('conf-name'),
            confDesc: document.getElementById('conf-desc'),
            confAuthor: document.getElementById('conf-author'),
            confVersion: document.getElementById('conf-version'),
            confEngine: document.getElementById('conf-engine'),
            depList: document.getElementById('dependencies-list'),
            
            tabFiles: document.getElementById('tab-files'),
            tabTexture: document.getElementById('tab-texture'),
            viewEditor: document.getElementById('view-editor'),
            viewTexture: document.getElementById('view-texture'),
            
            aiPrompt: document.getElementById('ai-prompt'),
            aiStatus: document.getElementById('ai-status'),
            spinner: document.getElementById('ai-spinner'),
            sendIcon: document.getElementById('send-icon'),
            
            texturePrompt: document.getElementById('texture-prompt'),
            currentPackIcon: document.getElementById('current-pack-icon'),
            noIconMsg: document.getElementById('no-icon-msg'),
            iconOverlay: document.getElementById('icon-overlay'),
            textureError: document.getElementById('texture-error')
        };

        function renderFileTree() {
            els.fileTree.innerHTML = '';
            // Sort files
            const sorted = [...state.files].sort((a, b) => a.path.localeCompare(b.path));
            
            sorted.forEach(file => {
                const div = document.createElement('div');
                const isSelected = file.path === state.selectedFile;
                div.className = `flex items-center py-1 px-2 cursor-pointer text-sm truncate transition-colors ${isSelected ? 'bg-subtle text-white border-l-2 border-primary' : 'text-gray-400 hover:bg-surface'}`;
                
                // Simple Icon Logic
                let icon = 'ðŸ“„';
                if (file.path.endsWith('.json')) icon = 'ðŸ”§';
                if (file.path.endsWith('.js')) icon = 'ðŸ“œ';
                if (file.path.endsWith('.png')) icon = 'ðŸ–¼ï¸';
                
                div.textContent = `${icon} ${file.path}`;
                div.onclick = () => {
                    state.selectedFile = file.path;
                    renderFileTree(); // Re-render for highlight
                    renderEditor();
                };
                els.fileTree.appendChild(div);
            });
        }

        function renderEditor() {
            const file = state.files.find(f => f.path === state.selectedFile);
            if (!file) {
                els.editor.value = '';
                els.editorFileName.textContent = 'No file selected';
                return;
            }

            els.editorFileName.textContent = file.path;
            
            if (file.isBinary) {
                els.editor.classList.add('hidden');
                els.imagePreviewArea.classList.remove('hidden');
                if (file.path.endsWith('.png')) {
                    els.imagePreviewImg.src = `data:image/png;base64,${file.content}`;
                    els.imagePreviewArea.querySelector('img').classList.remove('hidden');
                    els.imagePreviewArea.textContent = '';
                    els.imagePreviewArea.appendChild(els.imagePreviewImg);
                } else {
                    els.imagePreviewArea.textContent = "Binary file (cannot preview)";
                }
                els.editorStats.textContent = `${Math.round(file.content.length * 0.75 / 1024)} KB`;
            } else {
                els.editor.classList.remove('hidden');
                els.imagePreviewArea.classList.add('hidden');
                els.editor.value = file.content;
                els.editorStats.textContent = `${file.content.length} chars`;
                
                // Show debug button only for JS
                const debugBtn = document.getElementById('debug-btn');
                if (file.path.endsWith('.js')) {
                    debugBtn.classList.remove('hidden');
                } else {
                    debugBtn.classList.add('hidden');
                }
            }
        }

        function renderConfig() {
            els.confName.value = state.config.name;
            els.confDesc.value = state.config.description;
            els.confAuthor.value = state.config.author;
            els.confVersion.value = state.config.version.join('.');
            els.confEngine.value = state.config.minEngineVersion.join('.');
            
            els.depList.innerHTML = '';
            state.config.dependencies.forEach((dep, idx) => {
                const row = document.createElement('div');
                row.className = "flex gap-2 mb-2";
                row.innerHTML = `
                    <input class="flex-1 p-1 bg-surface border border-muted rounded text-xs text-gray-300" value="${dep.module_name}" data-idx="${idx}" data-field="module_name">
                    <input class="w-20 p-1 bg-surface border border-muted rounded text-xs text-gray-300" value="${dep.version}" data-idx="${idx}" data-field="version">
                    <button class="text-red-400 hover:text-red-300" onclick="removeDep(${idx})">Ã—</button>
                `;
                els.depList.appendChild(row);
            });
            
            // Attach listeners to dynamic inputs
            els.depList.querySelectorAll('input').forEach(input => {
                input.onchange = (e) => {
                    const idx = parseInt(e.target.dataset.idx);
                    const field = e.target.dataset.field;
                    state.config.dependencies[idx][field] = e.target.value;
                };
            });
        }

        function renderTexturePreview() {
            if (state.packIconBase64) {
                els.currentPackIcon.src = `data:image/png;base64,${state.packIconBase64}`;
                els.currentPackIcon.classList.remove('hidden');
                els.iconOverlay.classList.remove('hidden');
                els.noIconMsg.classList.add('hidden');
            } else {
                els.currentPackIcon.classList.add('hidden');
                els.iconOverlay.classList.add('hidden');
                els.noIconMsg.classList.remove('hidden');
            }
        }

        function switchTab(tab) {
            if (tab === 'Files') {
                els.tabFiles.classList.add('text-primary', 'border-primary');
                els.tabFiles.classList.remove('text-gray-400', 'border-transparent');
                els.tabTexture.classList.remove('text-primary', 'border-primary');
                els.tabTexture.classList.add('text-gray-400', 'border-transparent');
                els.viewEditor.classList.remove('hidden');
                els.viewTexture.classList.add('hidden');
            } else {
                els.tabTexture.classList.add('text-primary', 'border-primary');
                els.tabTexture.classList.remove('text-gray-400', 'border-transparent');
                els.tabFiles.classList.remove('text-primary', 'border-primary');
                els.tabFiles.classList.add('text-gray-400', 'border-transparent');
                els.viewTexture.classList.remove('hidden');
                els.viewEditor.classList.add('hidden');
                renderTexturePreview();
            }
        }

        function setAILoading(loading) {
            if (loading) {
                els.spinner.classList.remove('hidden');
                els.sendIcon.classList.add('hidden');
                document.getElementById('send-ai-btn').disabled = true;
            } else {
                els.spinner.classList.add('hidden');
                els.sendIcon.classList.remove('hidden');
                document.getElementById('send-ai-btn').disabled = false;
            }
        }

        // ==========================================
        // Event Listeners
        // ==========================================
        function setupEventListeners() {
            // Tab Switching
            els.tabFiles.onclick = () => switchTab('Files');
            els.tabTexture.onclick = () => switchTab('Texture');
            
            // Config Changes
            els.confName.onchange = (e) => state.config.name = e.target.value;
            els.confDesc.onchange = (e) => state.config.description = e.target.value;
            els.confAuthor.onchange = (e) => state.config.author = e.target.value;
            els.confVersion.onchange = (e) => state.config.version = e.target.value.split('.').map(Number);
            els.confEngine.onchange = (e) => state.config.minEngineVersion = e.target.value.split('.').map(Number);
            
            // Add Dependency
            document.getElementById('add-dep-btn').onclick = () => {
                state.config.dependencies.push({ module_name: '', version: '' });
                renderConfig();
            };
            
            // Save Config
            document.getElementById('save-config-btn').onclick = () => {
                const manifest = generateManifest(state.config);
                updateFileInState('manifest.json', JSON.stringify(manifest, null, 2));
                alert('Configuration saved to manifest.json');
                renderEditor();
            };

            // Code Editing
            els.editor.oninput = (e) => {
                const file = state.files.find(f => f.path === state.selectedFile);
                if (file) file.content = e.target.value;
                els.editorStats.textContent = `${e.target.value.length} chars`;
            };

            // AI Generation
            document.getElementById('send-ai-btn').onclick = async () => {
                const prompt = els.aiPrompt.value.trim();
                if (!prompt) return;
                
                setAILoading(true);
                els.aiStatus.classList.add('hidden');
                
                try {
                    const explanation = await generateFiles(prompt);
                    els.aiPrompt.value = '';
                    els.aiStatus.textContent = "AI: " + (explanation || "Done.");
                    els.aiStatus.classList.remove('hidden');
                    els.aiStatus.classList.add('text-green-400');
                } catch (e) {
                    els.aiStatus.textContent = e.message;
                    els.aiStatus.classList.remove('hidden');
                    els.aiStatus.classList.add('text-red-400');
                } finally {
                    setAILoading(false);
                }
            };

            // Debug Button
            document.getElementById('debug-btn').onclick = async () => {
                const file = state.files.find(f => f.path === state.selectedFile);
                if (!file) return;
                
                const btn = document.getElementById('debug-btn');
                const originalText = btn.textContent;
                btn.textContent = "Checking...";
                btn.disabled = true;
                
                const result = await checkScript(file.content);
                
                els.aiStatus.textContent = "Debugger: " + result;
                els.aiStatus.classList.remove('hidden');
                els.aiStatus.className = "max-h-32 overflow-y-auto bg-surface border border-subtle rounded p-2 text-xs font-mono " + (result.includes("No issues") ? "text-blue-400" : "text-yellow-400");
                
                btn.textContent = originalText;
                btn.disabled = false;
            };

            // Texture Generation
            document.getElementById('gen-texture-btn').onclick = async () => {
                const prompt = els.texturePrompt.value.trim();
                const btn = document.getElementById('gen-texture-btn');
                
                if (!prompt) {
                    els.textureError.textContent = "Please enter a prompt.";
                    els.textureError.classList.remove('hidden');
                    return;
                }
                
                els.textureError.classList.add('hidden');
                btn.textContent = "Generating...";
                btn.disabled = true;
                
                try {
                    const base64 = await generatePollinationsImage(prompt);
                    updateFileInState('pack_icon.png', base64, true);
                } catch (e) {
                    els.textureError.textContent = e.message;
                    els.textureError.classList.remove('hidden');
                } finally {
                    btn.textContent = "Generate Icon";
                    btn.disabled = false;
                }
            };

            // Download & Import
            document.getElementById('download-btn').onclick = downloadPack;
            
            document.getElementById('import-btn').onclick = () => {
                document.getElementById('import-input').click();
            };
            
            document.getElementById('import-input').onchange = (e) => {
                if (e.target.files.length > 0) {
                    importPack(e.target.files[0]);
                }
            };

            // Reset API Key
            document.getElementById('reset-api-key').onclick = () => {
                localStorage.removeItem("GEMINI_API_KEY");
                location.reload();
            };
        }

        // Expose for onclick handlers in HTML strings
        window.removeDep = (idx) => {
            state.config.dependencies.splice(idx, 1);
            renderConfig();
        };

        // Boot
        init();

    </script>
</body>
</html>
